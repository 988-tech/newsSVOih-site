import fs from "fs";
import path from "path";

export default async function handler(req, res) {
  if (req.method !== "POST") return res.status(405).end();

  const data = req.body;

  // Проверяем, что это сообщение из канала
  if (data.message && data.message.chat && data.message.chat.type === "channel") {
    const text = data.message.text || "";
    const date = new Date(data.message.date * 1000).toISOString();

    const post = {
      text,
      date,
      message_id: data.message.message_id,
    };

    // Путь к файлу news.json
    const filePath = path.join(process.cwd(), "public", "news.json");

    // Читаем существующие посты
    let posts = [];
    if (fs.existsSync(filePath)) {
      const content = fs.readFileSync(filePath, "utf8");
      try {
        posts = JSON.parse(content);
      } catch {
        posts = [];
      }
    }

    // Добавляем новый пост в начало
    posts.unshift(post);

    // Оставляем максимум 50 последних постов
    if (posts.length > 50) posts = posts.slice(0, 50);

    // Сохраняем файл
    fs.writeFileSync(filePath, JSON.stringify(posts, null, 2), "utf8");

    console.log("✅ Новый пост сохранён:", text);
  }

  res.status(200).json({ ok: true });
}